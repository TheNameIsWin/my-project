name: Auto Sync PR Status with ClickUp

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  push:
    branches:
      - main

jobs:
  clickup_status_sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Sync PR with ClickUp
      env:
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
        PR_TITLE: ${{ github.event.pull_request.title || '' }}
        PR_URL: ${{ github.event.pull_request.html_url || '' }}
        PR_STATE: ${{ github.event.pull_request.state || '' }}
        PR_MERGED: ${{ github.event.pull_request.merged || false }}
        ACTOR: ${{ github.actor }}
        EVENT: ${{ github.event_name }}
      run: |
        echo "‚öôÔ∏è GitHub Event: $EVENT"

        # Set status based on event type
        if [ "$EVENT" == "pull_request" ]; then
          if [ "$PR_MERGED" == "true" ]; then
            STATUS="complete"
          elif [ "$PR_STATE" == "open" ]; then
            STATUS="in progress"
          else
            STATUS="to do"
          fi
        else
          STATUS="in progress"
        fi

        echo "üåÄ ClickUp Status: $STATUS"

        # Check if task already exists with same name
        existing_task=$(curl --silent --request GET \
          --url "https://api.clickup.com/api/v2/list/$CLICKUP_LIST_ID/task?archived=false" \
          --header "Authorization: $CLICKUP_API_TOKEN" | jq -r ".tasks[] | select(.name==\"PR: $PR_TITLE\") | .id")

        if [ -z "$existing_task" ]; then
          echo "üÜï Task not found ‚Äî creating new one..."
          response=$(curl --silent --request POST \
            --url https://api.clickup.com/api/v2/list/$CLICKUP_LIST_ID/task \
            --header "Authorization: $CLICKUP_API_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{
              \"name\": \"PR: $PR_TITLE\",
              \"description\": \"üîó $PR_URL\nCreated by $ACTOR\",
              \"status\": \"$STATUS\"
            }")
          echo "‚úÖ New Task Created"
        else
          echo "üîÅ Existing Task Found ($existing_task) ‚Äî updating status..."
          curl --silent --request PUT \
            --url "https://api.clickup.com/api/v2/task/$existing_task" \
            --header "Authorization: $CLICKUP_API_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{
              \"status\": \"$STATUS\"
            }"
          echo "‚úÖ Task Updated to $STATUS"
        fi
