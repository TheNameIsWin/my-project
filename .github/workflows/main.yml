name: Auto Sync PR Status with ClickUp

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  push:
    branches:
      - main

jobs:
  clickup_status_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Sync PR with ClickUp
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
          PR_TITLE: ${{ github.event.pull_request.title || '' }}
          PR_URL: ${{ github.event.pull_request.html_url || '' }}
          PR_STATE: ${{ github.event.pull_request.state || '' }}
          PR_MERGED: ${{ github.event.pull_request.merged || false }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
        run: |
          echo "‚öôÔ∏è GitHub Event: $EVENT"
          echo "üîç PR_TITLE: $PR_TITLE"
          echo "üîç PR_STATE: $PR_STATE"
          echo "üîç PR_MERGED: $PR_MERGED"
          echo "üîç ACTOR: $ACTOR"

          # Determine ClickUp status based on PR state
          if [ "$EVENT" == "pull_request" ]; then
            if [ "$PR_MERGED" == "true" ]; then
              STATUS="Done"
            elif [ "$PR_STATE" == "open" ]; then
              STATUS="In Progress"
            else
              STATUS="To Do"
            fi
          else
            STATUS="In Progress"
          fi

          echo "üåÄ ClickUp Status to Apply: $STATUS"

          # Fetch existing task by PR title
          existing_task=$(curl --silent --request GET \
            --url "https://api.clickup.com/api/v2/list/$CLICKUP_LIST_ID/task?archived=false" \
            --header "Authorization: $CLICKUP_API_TOKEN" | jq -r ".tasks[] | select(.name==\"PR: $PR_TITLE\") | .id" | head -n1)

          if [ -z "$existing_task" ]; then
            echo "üÜï No existing task found ‚Äî creating a new one..."
            response=$(curl --silent --request POST \
              --url "https://api.clickup.com/api/v2/list/$CLICKUP_LIST_ID/task" \
              --header "Authorization: $CLICKUP_API_TOKEN" \
              --header "Content-Type: application/json" \
              --data "{
                \"name\": \"PR: $PR_TITLE\",
                \"description\": \"üîó [Pull Request Link]($PR_URL)\\nüë§ Created by: $ACTOR\",
                \"status\": \"$STATUS\"
              }")
            
            new_task_id=$(echo "$response" | jq -r '.id')
            echo "‚úÖ New ClickUp task created with ID: $new_task_id"
          else
            echo "üîÅ Existing task found (ID: $existing_task) ‚Äî updating status..."
            curl --silent --request PUT \
              --url "https://api.clickup.com/api/v2/task/$existing_task" \
              --header "Authorization: $CLICKUP_API_TOKEN" \
              --header "Content-Type: application/json" \
              --data "{
                \"status\": \"$STATUS\"
              }"
            echo "‚úÖ Task updated to status: $STATUS"
          fi

          echo "üéØ ClickUp sync completed successfully!"
