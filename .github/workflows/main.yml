name: Auto Sync PR Status with ClickUp

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  push:
    branches:
      - main

jobs:
  clickup_status_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Sync PR with ClickUp
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title || '' }}
          PR_URL: ${{ github.event.pull_request.html_url || '' }}
          PR_STATE: ${{ github.event.pull_request.state || '' }}
          PR_MERGED: ${{ github.event.pull_request.merged || false }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
          PR_NUMBER: ${{ github.event.pull_request.number || 0 }}
        run: |
          echo "‚öôÔ∏è GitHub Event: $EVENT"
          echo "üîç PR_TITLE: $PR_TITLE"
          echo "üîç PR_STATE: $PR_STATE"
          echo "üîç PR_MERGED: $PR_MERGED"
          echo "üîç ACTOR: $ACTOR"

          # üß† Determine ClickUp status (Match EXACT names in your workspace)
          if [ "$EVENT" == "pull_request" ]; then
            if [ "$PR_MERGED" == "true" ]; then
              STATUS="Done"
            elif [ "$PR_STATE" == "open" ]; then
              STATUS="In Progress"
            else
              STATUS="To Do"
            fi
          else
            STATUS="In Progress"
          fi

          echo "üåÄ ClickUp Status to Apply: $STATUS"

          # üß© Fetch all tasks in ClickUp list
          tasks_json=$(curl --silent --request GET \
            --url "https://api.clickup.com/api/v2/list/$CLICKUP_LIST_ID/task?archived=false" \
            --header "Authorization: $CLICKUP_API_TOKEN")

          existing_task=$(echo "$tasks_json" | jq -r ".tasks[] | select(.name==\"PR: $PR_TITLE\") | .id" | head -n1)

          # üß± If no task exists, create one
          if [ -z "$existing_task" ]; then
            echo "üÜï No existing task found ‚Äî creating new one..."
            create_response=$(curl --silent --write-out "\nHTTP_STATUS:%{http_code}\n" --request POST \
              --url "https://api.clickup.com/api/v2/list/$CLICKUP_LIST_ID/task" \
              --header "Authorization: $CLICKUP_API_TOKEN" \
              --header "Content-Type: application/json" \
              --data "{
                \"name\": \"PR: $PR_TITLE\",
                \"description\": \"üîó [Pull Request Link]($PR_URL)\\nüë§ Created by: $ACTOR\",
                \"status\": \"$STATUS\"
              }")

            new_task_id=$(echo "$create_response" | jq -r '.id')
            echo "‚úÖ New ClickUp Task Created ‚Äî ID: $new_task_id"
            TASK_URL="https://app.clickup.com/t/$new_task_id"

            # Comment back on PR with ClickUp link
            curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -X POST \
              -d "{\"body\": \"üÜï **ClickUp Task Created:** [View Task]($TASK_URL)\\nüìå Status: $STATUS\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments"

          else
            # üõ† Update existing task
            echo "üîÅ Existing Task Found (ID: $existing_task) ‚Äî Updating status..."
            update_response=$(curl --silent --write-out "\nHTTP_STATUS:%{http_code}\n" --request PUT \
              --url "https://api.clickup.com/api/v2/task/$existing_task" \
              --header "Authorization: $CLICKUP_API_TOKEN" \
              --header "Content-Type: application/json" \
              --data "{
                \"status\": \"$STATUS\"
              }")

            echo "‚úÖ Task Updated to Status: $STATUS"

            # Comment on PR about status change
            curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -X POST \
              -d "{\"body\": \"üîÑ **ClickUp Task Updated:** Status changed to *$STATUS*\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments"
          fi

          echo "üéØ ClickUp Sync Completed Successfully!"
