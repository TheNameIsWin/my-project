name: Auto Sync with ClickUp (PR + Status Update)

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  push:
    branches:
      - main

jobs:
  clickup_sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Sync Task with ClickUp
      env:
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
        GITHUB_EVENT_NAME: ${{ github.event_name }}
        PR_TITLE: ${{ github.event.pull_request.title || '' }}
        PR_URL: ${{ github.event.pull_request.html_url || '' }}
        PR_STATE: ${{ github.event.pull_request.state || '' }}
        PR_MERGED: ${{ github.event.pull_request.merged || false }}
        ACTOR: ${{ github.actor }}
      run: |
        echo "GitHub Event: $GITHUB_EVENT_NAME"

        # Identify ClickUp Status
        if [ "$GITHUB_EVENT_NAME" == "pull_request" ]; then
          if [ "$PR_MERGED" == "true" ]; then
            STATUS="complete"
          elif [ "$PR_STATE" == "open" ]; then
            STATUS="in progress"
          else
            STATUS="to do"
          fi
        else
          STATUS="in progress"
        fi

        echo "ðŸŒ€ Setting ClickUp status: $STATUS"

        # Create or update task
        response=$(curl --request POST \
          --url https://api.clickup.com/api/v2/list/$CLICKUP_LIST_ID/task \
          --header "Authorization: $CLICKUP_API_TOKEN" \
          --header "Content-Type: application/json" \
          --data "{
            \"name\": \"PR: $PR_TITLE\",
            \"description\": \"PR by $ACTOR\nðŸ”— $PR_URL\",
            \"status\": \"$STATUS\"
          }")

        echo "Response: $response"
