name: Sync with ClickUp (Auto Task + PR Notification)

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  clickup_integration:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v3

    - name: Create or Update ClickUp Task
      env:
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_REPO: ${{ github.repository }}
        GITHUB_PR_TITLE: ${{ github.event.pull_request.title || '' }}
        GITHUB_PR_URL: ${{ github.event.pull_request.html_url || '' }}
        GITHUB_COMMIT_MESSAGE: ${{ github.event.head_commit.message || '' }}
        GITHUB_EVENT_NAME: ${{ github.event_name }}
      run: |
        echo "Event: $GITHUB_EVENT_NAME"
        echo "List ID: $CLICKUP_LIST_ID"

        if [ "$GITHUB_EVENT_NAME" == "pull_request" ]; then
          echo "ðŸ“£ PR Detected! Creating a PR-related task..."
          curl --request POST \
            --url https://api.clickup.com/api/v2/list/$CLICKUP_LIST_ID/task \
            --header "Authorization: $CLICKUP_API_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{
              \"name\": \"PR: $GITHUB_PR_TITLE\",
              \"description\": \"Pull Request by $GITHUB_ACTOR in $GITHUB_REPO\n\nðŸ”— $GITHUB_PR_URL\",
              \"status\": \"to do\",
              \"priority\": 2
            }"
        else
          echo "ðŸš€ Push detected! Creating commit-related task..."
          curl --request POST \
            --url https://api.clickup.com/api/v2/list/$CLICKUP_LIST_ID/task \
            --header "Authorization: $CLICKUP_API_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{
              \"name\": \"Commit: $GITHUB_COMMIT_MESSAGE\",
              \"description\": \"Commit pushed by $GITHUB_ACTOR in $GITHUB_REPO\",
              \"status\": \"in progress\",
              \"priority\": 3
            }"
        fi
